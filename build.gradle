import java.security.MessageDigest

plugins {
    id 'java'
    id 'maven-publish'
    id 'signing'
}

group = 'io.github.tehnewb'
version = '1.0.0'
description = 'Valthorne'

java {
    toolchain {
        languageVersion = JavaLanguageVersion.of(23)
    }
    withSourcesJar()
    withJavadocJar()
}

def lwjglVersion = "3.3.4"
def lwjglNatives = "natives-windows"

repositories {
    mavenCentral()
}

dependencies {
    implementation platform("org.lwjgl:lwjgl-bom:$lwjglVersion")

    implementation "org.lwjgl:lwjgl"
    implementation "org.lwjgl:lwjgl-glfw"
    implementation "org.lwjgl:lwjgl-opengl"
    implementation "org.lwjgl:lwjgl-stb"
    implementation "org.lwjgl:lwjgl-openal"

    implementation "com.googlecode.soundlibs:mp3spi:1.9.5-1"
    implementation "com.googlecode.soundlibs:tritonus-share:0.3.7-2"

    runtimeOnly "org.lwjgl:lwjgl::$lwjglNatives"
    runtimeOnly "org.lwjgl:lwjgl-glfw::$lwjglNatives"
    runtimeOnly "org.lwjgl:lwjgl-opengl::$lwjglNatives"
    runtimeOnly "org.lwjgl:lwjgl-stb::$lwjglNatives"
    runtimeOnly "org.lwjgl:lwjgl-openal::$lwjglNatives"
}

tasks.withType(JavaCompile).configureEach {
    options.encoding = 'UTF-8'
}

tasks.withType(Javadoc).configureEach {
    options.addStringOption('Xdoclint:none', '-quiet')
    options.addStringOption('encoding', 'UTF-8')
    options.addBooleanOption('html5', true)
    failOnError = false
}

/* =======================
   Maven publication
   ======================= */

publishing {
    publications {
        mavenJava(MavenPublication) {
            artifactId = 'valthorne'   // ðŸ”‘ FORCE lowercase filename
            from components.java

            pom {
                name = 'Valthorne'
                description = 'Valthorne game framework'
                url = 'https://github.com/tehnewb/Valthorne'

                licenses {
                    license {
                        name = 'MIT License'
                        url = 'https://opensource.org/licenses/MIT'
                    }
                }

                developers {
                    developer {
                        id = 'tehnewb'
                        name = 'Albert Beaupre'
                        url = 'https://github.com/tehnewb'
                    }
                }

                scm {
                    url = 'https://github.com/tehnewb/Valthorne'
                    connection = 'scm:git:https://github.com/tehnewb/Valthorne.git'
                    developerConnection = 'scm:git:ssh://git@github.com:tehnewb/Valthorne.git'
                }
            }
        }
    }
}


signing {
    useGpgCmd()
    sign publishing.publications.mavenJava
}

/* =======================
   Central Portal bundle
   ======================= */

def centralGroupPath = group.replace('.', '/')
def centralArtifactId = 'valthorne'
def centralVersion = version

def centralBundleDir = layout.buildDirectory.dir(
        "central-bundle/pkg/maven/${centralGroupPath}/${centralArtifactId}/${centralVersion}"
)
tasks.register('prepareCentralBundle') {
    dependsOn 'build',
            'generatePomFileForMavenJavaPublication',
            'signMavenJavaPublication'

    doLast {
        def dst = centralBundleDir.get().asFile
        dst.mkdirs()

        // JARs
        copy {
            from("$buildDir/libs")
            include "*.jar"
            into dst
        }

        // POM (generated by Gradle)
        copy {
            from("$buildDir/publications/mavenJava/pom-default.xml")
            into dst
            rename { "${centralArtifactId}-${centralVersion}.pom" }
        }

        // Signatures
        copy {
            from("$buildDir/libs")
            include "*.asc"
            into dst
        }
        copy {
            from("$buildDir/publications/mavenJava")
            include "*.asc"
            into dst
        }

        // Checksums
        dst.eachFile { f ->
            if (!f.name.endsWith('.md5') && !f.name.endsWith('.sha1')) {
                file("${f.absolutePath}.md5").text = checksum(f, 'MD5')
                file("${f.absolutePath}.sha1").text = checksum(f, 'SHA-1')
            }
        }
    }
}

tasks.register('centralBundleZip', Zip) {
    dependsOn 'prepareCentralBundle'
    archiveFileName = "valthorne-${version}-central.zip"
    destinationDirectory = layout.buildDirectory.dir("central")
    from(layout.buildDirectory.dir("central-bundle"))
}

static String checksum(File file, String algo) {
    MessageDigest md = MessageDigest.getInstance(algo)
    file.eachByte(8192) { buf, n -> md.update(buf, 0, n) }
    return md.digest().encodeHex().toString()
}
